<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>lesson 4</title>
  <link rel="stylesheet" href="../../sources/openlayers/v5.3.0/css/ol.css" />
  <script src="../../sources/openlayers/v5.3.0/build/ol.js"></script>
</head>
<body>
  <div id="map" class="map"></div>
  <script>
    var polyline = [
      'hldhx@lnau`BCG_Eac??cFjAwDjF??uBlKMd@}@z@??aC^yk@z_@se@b[wFdE??wFfE}N',
      'fIoGxB_I\\gG}@eHoCyTmPqGaBaHOod\\??yVrGotA|N??o[N_STiwAtEmHGeHcAKiA}^',
      'aMyBiHOkFNoI`CcVvM??gG^gF_@iJwC??eCcAJOoL}DwFyCaCgCcCwDcGWHsSoX??wI_E',
      'kUFmq@hBiOqBgTwS??iYse@gYq\\cp@ce@{vA}s@csJqaE}{@iRaqE{lBeRoIwd@_T{]_',
      'Ngn@{PmhEwaA{SeF_u@kQuyAw]wQeEgtAsZ}LiCarAKVwI}D??_}RcjEinPspDwSqCgs@',
      'sPua@_OkXaMeT_Nwk@ob@gV}TiYs[uTwXoNmT{Uyb@wNg]{Nqa@oDgNeJu_@_G}YsFw}k',
      'DuZyDmm@i_@uyIJe~@jCg|@nGiv@zUi_BfNqaAvIow@dEed@dCcf@r@qz@Egs@{Acu@mc',
      'um@yIey@gGig@cK_m@aSku@qRil@we@{mAeTej@}Tkz@cLgr@aHko@qOmcEaJw~C{w@ka',
      'i@qBchBq@kmBS{kDnBscBnFu_Dbc@_~QHeU`IuyDrC_}@bByp@fCyoA?qMbD}{AIkeAgB',
      'k_A_A{UsDke@gFej@qH{o@qGgb@qH{`@mMgm@uQus@kL{_@yOmd@ymBgwE}x@ouBwtA__',
      'DuhEgaKuWct@gp@cnBii@mlBa_@}|Asj@qrCg^eaC}L{dAaJ_aAiOyjByH{nAuYu`GsAw',
      'Xyn@ywMyOyqD{_@cfIcDe}@y@aeBJmwA`CkiAbFkhBLTgdDdPyiB`W}xDnSa}DbJyhCrX',
      'itAhT}x@bE}Z_@qW_Kwv@qKaaAiBgXvIm}A~JovAxCqW~WanB`XewBbk{_A`K}fBvAmi@',
      'xBycBeCauBoF}}@qJioAww@gjHaPopA_NurAyJku@uGmi@cDs[eRaiBkQstAsQkcByNma',
      'CsK_uBcJgbEw@gkB_@ypEqDoqSm@eZcDwjBoGw`BoMegBaU_`Ce_@_uBqb@ytBwkFqiT_',
      'fAqfEwe@mfCka@_eC_UmlB}MmaBeWkkDeHwqAoX}~DcBsZmLcxBqOwqE_DkyAuJmrJ\\o',
      '~CfIewG|YibQxBssB?es@qGciA}RorAoVajA_nAodD{[y`AgPqp@mKwr@ms@umEaW{dAm',
      'b@umAw|@ojBwzDaaJsmBwbEgdCsrFqhAihDquAi`Fux@}_Dui@_eB_u@guCuyAuiHukA_',
      'lKszAu|OmaA{wKm}@ckGs_A_rEahCss',
    ];

    var route = (new ol.format.Polyline({
      factor: 1e6
    }).readGeometry(polyline, {
      dataProjection: 'EPSG:4326',
      featureProjection: 'EPSG:3857',
    }))

    var routeCoords = route.getCoordinates();
    var routeLength = routeCoords.length;

    var routeFeature = new ol.Feature({
      type: 'route',
      geometry: route,
    });
    var geoMarker = new ol.Feature({
      type: 'geoMarker',
      geometry: new ol.geom.Point(routeCoords[0])
    });
    var startMarker = new ol.Feature({
      type: 'icon',
      geometry: new ol.geom.Point(routeCoords[0])
    });
    var endMarker = new ol.Feature({
      type: 'icon',
      geometry: new ol.geom.Point(routeCoords[routeLength-1])
    });

    var styles = {
      'route': new ol.style.Style({
        stroke: new ol.style.Stroke({
          width: 6, color: [237, 212, 0, 0.8]
        })
      }),
      'icon': new ol.style.Style({
        image: new ol.style.Icon({
          anchor: [0.5, 1],
          src: '../data/icon.png'
        })
      }),
      'geoMarker': new ol.style.Style({
        image: new ol.style.Circle({
          radius: 7,
          fill: new ol.style.Fill({ color: 'black'}),
          stroke: new ol.style.Stroke({
            color: 'white', width: 2
          })
        })
      }),
    };

    var animating = false;
    var speed, now;
    var speedInput = document.getElementById('speed');
    var startButton = document.getElementById('start-animation');

    var vectorLayer = new ol.layer.Vector({
      source: new ol.source.Vector({
        features: [routeFeature, geoMarker, startMarker, endMarker]
      }),
      style: function(feature){
        if(animating && feature.get('type') === 'geoMarker'){
          return null;
        }
        return styles[feature.get('type')];
      }
    });

    var center = [-5639523.95, -3501274.53];
    var map = new ol.Map({
      target: document.getElementById('map'),
      loadTilesWhileAnimating: true,
      view: new ol.View({
        center: center,
        zoom: 10,
        minZoom: 2,
        maxZoom: 19,
      }),
      layers: [
        new ol.layer.Tile({
          source: new ol.source.BingMaps({
            imagerySet: 'AerialWithLabels',
            key: 'As1HiMj1PvLplqc_gtM7AqZfBL8ZL3VrjaS3zIb22Uvb9WKhuJObROC-qUpa81U5'
          }),
          vectorLayer,
        })
      ]
    });

    var moveFeature = function(event){
      var vectorContext = event.vectorContext;
      var frameState = event.frameState;

      if(animating){
        var elapsedTime = frameState.time - now;

        var index = Math.round(speed * elapsedTime / 1000);

        if(index >= routeLength){
          stopAnimation(true);
          return;
        }

        var currentPoint = new ol.geom.Point(routeCoords[index]);
        var feature = new ol.Feature(currentPoint);
        vectorContext.drawFeature(feature, styles.geoMarker);
      }

      map.render();
    };

    function startAnimation(){
      if(animating){
        stopAnimation(false);
      } else {
        animating = true;
        now = new Date().getTime();
        speed = speedInput.value;
        startButton.textContent = '停止移动';
        geoMarker.setStyle(null);

        map.getView().setCenter(center);
        map.on('postcompose', moveFeature);
        map.render();
      }
    }

    function stopAnimation(ended){
      animating = false;
      startButton.textContent = '开始移动';

      var coord = ended ? routeCoords[routeLength-1] : routeCoords[0];
      geoMarker.getGeometry().setCoordinates(coord);

      map.un('postcompose', moveFeature)
    }

    startButton.addEventListener('click', startAnimation, false);
  </script>
</body>
</html>